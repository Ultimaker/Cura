#!/bin/bash
# UltiMaker Cura Flatpak wrapper script
# Copyright (c) 2024 UltiMaker
# Cura is released under the terms of the LGPLv3 or higher.

# Set up environment variables for Cura
export PYTHONPATH="/app/lib/python3.12/site-packages:${PYTHONPATH}"
export QT_PLUGIN_PATH="/app/lib/qt6/plugins"
export QML2_IMPORT_PATH="/app/lib/qt6/qml"
export QT_QPA_PLATFORMTHEME="kde"

# Set up library paths
export LD_LIBRARY_PATH="/app/lib:${LD_LIBRARY_PATH}"
export GDK_PIXBUF_MODULEDIR="/app/lib/gdk-pixbuf-2.0/2.10.0/loaders"

# Security: Remove working directory from Python path
if [ -n "${PYTHONPATH}" ]; then
    export PYTHONPATH=$(echo "${PYTHONPATH}" | sed 's/::/:/g' | sed 's/^://' | sed 's/:$//')
fi

# Set Qt settings for better Linux integration
export QT_QPA_PLATFORM="xcb"
export QT_QUICK_CONTROLS_STYLE="default"
export QT_QUICK_FLICKABLE_WHEEL_DECELERATION="5000"

# Ensure proper locale handling
export LC_ALL="${LC_ALL:-C.UTF-8}"

# Change to app directory to ensure relative paths work
cd /app

# Execute the actual Cura application
exec python3 cura_app.py "$@"